<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NI/EU Law Relevance Tracker</title>
    <style>
        :root {
            --primary-blue: #003d5b;
            --primary-teal: #00838f;
            --accent-teal: #4db6ac;
            --light-teal: #e0f2f1;
            --critical-red: #c62828;
            --high-amber: #ef6c00;
            --medium-blue: #1565c0;
            --low-grey: #546e7a;
            --white: #ffffff;
            --light-grey: #f5f7fa;
            --text-dark: #1a1a2e;
            --text-muted: #5a6a7a;
            --border-colour: #d1d9e0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-grey);
            color: var(--text-dark);
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .header-content { max-width: 1400px; margin: 0 auto; }
        .header h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem; }
        .header-subtitle { font-size: 0.9rem; opacity: 0.9; }

        .nav-tabs {
            background: var(--white);
            border-bottom: 1px solid var(--border-colour);
            padding: 0 2rem;
        }

        .nav-tabs-inner { max-width: 1400px; margin: 0 auto; display: flex; gap: 0; }

        .nav-tab {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-tab:hover { color: var(--primary-teal); background: var(--light-teal); }
        .nav-tab.active { color: var(--primary-teal); border-bottom-color: var(--primary-teal); }

        .main-content { max-width: 1400px; margin: 0 auto; padding: 1.5rem 2rem; }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1.25rem;
            border-left: 4px solid var(--primary-teal);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .stat-card.critical { border-left-color: var(--critical-red); }
        .stat-card.high { border-left-color: var(--high-amber); }
        .stat-card.medium { border-left-color: var(--medium-blue); }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--text-dark); }

        .filters-bar {
            background: var(--white);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .filter-group label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-group select, .filter-group input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-colour);
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 180px;
        }

        .legislation-list { display: flex; flex-direction: column; gap: 0.75rem; }

        .legislation-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--low-grey);
        }

        .legislation-card.critical { border-left-color: var(--critical-red); }
        .legislation-card.high { border-left-color: var(--high-amber); }
        .legislation-card.medium { border-left-color: var(--medium-blue); }
        
        .legislation-card.baseline { 
            border-left-color: var(--primary-blue); 
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        }

        .baseline-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            background: var(--primary-blue);
            color: var(--white);
            margin-right: 0.5rem;
        }

        .legislation-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 0.75rem; }
        .legislation-title { font-size: 1rem; font-weight: 600; color: var(--text-dark); flex: 1; }
        .legislation-title a { color: inherit; text-decoration: none; }
        .legislation-title a:hover { color: var(--primary-teal); text-decoration: underline; }

        .priority-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            color: var(--white);
        }

        .priority-badge.critical { background: var(--critical-red); }
        .priority-badge.high { background: var(--high-amber); }
        .priority-badge.medium { background: var(--medium-blue); }
        .priority-badge.low { background: var(--low-grey); }

        .legislation-meta { display: flex; flex-wrap: wrap; gap: 1.5rem; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem; }
        .meta-item { display: flex; align-items: center; gap: 0.35rem; }
        .meta-item strong { color: var(--text-dark); font-weight: 500; }

        .legislation-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tag { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 3px; background: var(--light-grey); color: var(--text-muted); }
        .tag.category { background: var(--light-teal); color: var(--primary-teal); }
        .tag.department { background: #e8eaf6; color: #3949ab; }
        .tag.consultation { background: #fff3e0; color: #e65100; }
        .tag.consultation-urgent { background: #ffebee; color: #c62828; font-weight: 600; animation: pulse 2s infinite; }
        .tag.dsc { background: #fce4ec; color: #c2185b; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .consultation-countdown {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-weight: 600;
        }
        .consultation-countdown.urgent { background: #ffebee; color: #c62828; }
        .consultation-countdown.soon { background: #fff3e0; color: #e65100; }
        .consultation-countdown.normal { background: #e8f5e9; color: #2e7d32; }

        .legislation-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-colour);
        }

        .action-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            text-decoration: none;
            border-radius: 4px;
        }

        .action-link.primary { background: var(--primary-teal); color: var(--white); }
        .action-link.consultation { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
        .action-link.dsc { background: #fce4ec; color: #c2185b; border: 1px solid #f48fb1; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .categories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .category-card { background: var(--white); border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); }
        .category-number { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .category-name { font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; }
        .category-relevance { font-size: 0.8rem; }
        .category-relevance.high { color: var(--critical-red); }
        .category-relevance.medium { color: var(--high-amber); }
        .category-relevance.low { color: var(--low-grey); }

        .about-section { background: var(--white); border-radius: 8px; padding: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); }
        .about-section h2 { color: var(--primary-blue); margin-bottom: 1rem; }
        .about-section h3 { color: var(--primary-teal); margin: 1.5rem 0 0.75rem 0; }
        .about-section p { margin-bottom: 1rem; }

        .scoring-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .scoring-table th, .scoring-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-colour); }
        .scoring-table th { background: var(--light-grey); font-weight: 600; }

        .footer { text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.85rem; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>NI/EU Law Relevance Tracker</h1>
            <p class="header-subtitle">Monitoring Windsor Framework Annex 2 legislation for Northern Ireland</p>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="nav-tabs-inner">
            <button class="nav-tab active" onclick="showTab('dashboard', this)">Dashboard</button>
            <button class="nav-tab" onclick="showTab('categories', this)">Annex 2 Categories</button>
            <button class="nav-tab" onclick="showTab('about', this)">About &amp; Scoring</button>
        </div>
    </nav>

    <main class="main-content">
        <div id="dashboard" class="tab-content active">
            <div class="stats-bar">
                <div class="stat-card critical">
                    <div class="stat-label">Critical Priority</div>
                    <div class="stat-value" id="stat-critical">2</div>
                </div>
                <div class="stat-card high">
                    <div class="stat-label">High Priority</div>
                    <div class="stat-value" id="stat-high">1</div>
                </div>
                <div class="stat-card medium">
                    <div class="stat-label">Medium Priority</div>
                    <div class="stat-value" id="stat-medium">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Open Consultations</div>
                    <div class="stat-value" id="stat-consultations">3</div>
                </div>
            </div>

            <div class="filters-bar">
                <div class="filter-group">
                    <label>Priority</label>
                    <select id="filter-priority" onchange="applyFilters()">
                        <option value="">All priorities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <select id="filter-category" onchange="applyFilters()">
                        <option value="">All categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Department</label>
                    <select id="filter-department" onchange="applyFilters()">
                        <option value="">All departments</option>
                        <option value="DAERA">DAERA</option>
                        <option value="DoH">DoH</option>
                        <option value="DfE">DfE</option>
                        <option value="DfI">DfI</option>
                        <option value="DoF">DoF</option>
                        <option value="DoJ">DoJ</option>
                        <option value="DfC">DfC</option>
                        <option value="TEO">TEO</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Type</label>
                    <select id="filter-type" onchange="applyFilters()">
                        <option value="">All legislation</option>
                        <option value="recent">Recent only</option>
                        <option value="baseline">Baseline only</option>
                        <option value="consultation">With open consultation</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="filter-search" placeholder="Search legislation..." oninput="applyFilters()">
                </div>
            </div>

            <div class="legislation-list" id="legislation-list"></div>
            <!-- Add this section to your index.html after the legislation cards section -->
<!-- CONSULTATIONS SECTION -->
<div id="consultations-section" class="consultations-section" style="margin-top: 2rem; display: none;">
    <h2 style="color: #003078; border-bottom: 3px solid #003078; padding-bottom: 0.5rem; margin-bottom: 1rem;">
        üìã Open EU Consultations
    </h2>
    <p style="color: #505a5f; margin-bottom: 1rem;">
        These consultations are relevant to Windsor Framework Annex 2 topics. Responding to consultations is a key way to influence EU policy.
    </p>
    <div id="consultations-list"></div>
</div>

<style>
/* Consultation Styles */
.consultations-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
}

.consultation-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-left: 4px solid #1d70b8;
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.consultation-card.urgent {
    border-left-color: #d4351c;
    background: #fef7f7;
}

.consultation-card.soon {
    border-left-color: #f47738;
    background: #fefaf7;
}

.consultation-title {
    font-weight: 600;
    color: #0b0c0c;
    margin-bottom: 0.5rem;
}

.consultation-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.9rem;
    color: #505a5f;
    margin-bottom: 0.75rem;
}

.consultation-countdown {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.85rem;
}

.countdown-urgent {
    background: #d4351c;
    color: white;
    animation: pulse 2s infinite;
}

.countdown-soon {
    background: #f47738;
    color: white;
}

.countdown-normal {
    background: #00703c;
    color: white;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.consultation-link {
    display: inline-block;
    background: #1d70b8;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.consultation-link:hover {
    background: #003078;
    color: white;
}
</style>

<script>
// Add this to your existing JavaScript

async function loadConsultations() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/consultations?status=eq.open&order=days_remaining.asc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to fetch consultations');
        
        const consultations = await response.json();
        
        if (consultations.length > 0) {
            document.getElementById('consultations-section').style.display = 'block';
            renderConsultations(consultations);
            
            // Update stat card
            document.getElementById('open-consultations-count').textContent = consultations.length;
        }
        
    } catch (error) {
        console.error('Error loading consultations:', error);
    }
}

function renderConsultations(consultations) {
    const container = document.getElementById('consultations-list');
    
    container.innerHTML = consultations.map(c => {
        const days = c.days_remaining || 30;
        let urgencyClass = '';
        let countdownClass = 'countdown-normal';
        let emoji = 'üìÖ';
        
        if (days <= 7) {
            urgencyClass = 'urgent';
            countdownClass = 'countdown-urgent';
            emoji = 'üö®';
        } else if (days <= 14) {
            urgencyClass = 'soon';
            countdownClass = 'countdown-soon';
            emoji = '‚è∞';
        }
        
        return `
            <div class="consultation-card ${urgencyClass}">
                <div class="consultation-title">${c.title}</div>
                <div class="consultation-meta">
                    <span class="consultation-countdown ${countdownClass}">
                        ${emoji} ${days} days remaining
                    </span>
                    <span>Closes: ${c.date_closes || 'TBC'}</span>
                </div>
                <a href="${c.consultation_url}" target="_blank" class="consultation-link">
                    üìù Respond to Consultation
                </a>
            </div>
        `;
    }).join('');
}

// Call this in your init function
// loadConsultations();
</script>
        </div>

        <div id="categories" class="tab-content">
            <div class="categories-grid" id="categories-grid"></div>
        </div>

        <div id="about" class="tab-content">
            <div class="about-section">
                <h2>About This Tracker</h2>
                <p>This tool monitors EU legislation that applies to Northern Ireland under the Windsor Framework (specifically Annex 2 of the Protocol on Ireland/Northern Ireland). It helps identify which legislation is most relevant to NI consumers and which NI departments should be aware.</p>

                <h3>How Scoring Works</h3>
                <p>Each piece of legislation receives a deterministic score based on the following factors. The same input always produces the same output - no AI guessing.</p>

                <table class="scoring-table">
                    <thead>
                        <tr><th>Factor</th><th>Points</th><th>Condition</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Direct Annex 2 match</td><td>+10</td><td>Legislation explicitly listed or directly amends/replaces listed legislation</td></tr>
                        <tr><td>Category keyword match</td><td>+5</td><td>Topic matches category keywords but not explicitly listed</td></tr>
                        <tr><td>High consumer relevance</td><td>+3</td><td>Category has high consumer impact (e.g., food, toys, medicines)</td></tr>
                        <tr><td>Medium consumer relevance</td><td>+1</td><td>Category has moderate consumer impact</td></tr>
                        <tr><td>Consultation closing &lt;14 days</td><td>+5</td><td>Open EU consultation with deadline within 2 weeks</td></tr>
                        <tr><td>Consultation closing &lt;30 days</td><td>+3</td><td>Open EU consultation with deadline within 1 month</td></tr>
                        <tr><td>Consultation open</td><td>+2</td><td>Open EU consultation with deadline more than 30 days away</td></tr>
                        <tr><td>DSC proposed list</td><td>+4</td><td>On NI Assembly DSC proposed new or replacement acts list</td></tr>
                        <tr><td>DSC published list</td><td>+2</td><td>On NI Assembly DSC published acts list</td></tr>
                        <tr><td>Regulation</td><td>+2</td><td>EU Regulation (directly applicable)</td></tr>
                        <tr><td>Directive/Decision</td><td>+1</td><td>EU Directive or Decision</td></tr>
                    </tbody>
                </table>

                <h3>Priority Levels</h3>
                <table class="scoring-table">
                    <thead>
                        <tr><th>Priority</th><th>Score</th><th>Action Required</th></tr>
                    </thead>
                    <tbody>
                        <tr><td><span class="priority-badge critical">Critical</span></td><td>18+</td><td>Immediate attention - prepare consultation response or brief</td></tr>
                        <tr><td><span class="priority-badge high">High</span></td><td>12-17</td><td>Monitor closely - plan engagement</td></tr>
                        <tr><td><span class="priority-badge medium">Medium</span></td><td>6-11</td><td>Track for future developments</td></tr>
                        <tr><td><span class="priority-badge low">Low</span></td><td>0-5</td><td>Log for completeness</td></tr>
                    </tbody>
                </table>

                <h3>Data Sources</h3>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li><strong>EUR-Lex</strong> - Official EU legislation database</li>
                    <li><strong>Windsor Framework Annex 2</strong> - The 47 categories of applicable EU law</li>
                    <li><strong>NI Assembly DSC</strong> - Democratic Scrutiny Committee monitoring lists</li>
                    <li><strong>EU Commission "Have Your Say"</strong> - Open consultations</li>
                </ul>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>NI/EU Law Relevance Tracker - Data updates daily at 02:00</p>
    </footer>

    <script>
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        var CATEGORIES = [
            { n: 1, name: "General customs aspects", rel: "low", dept: "DoF" },
            { n: 2, name: "Protection of the Union's financial interests", rel: "low", dept: "DoF" },
            { n: 3, name: "Trade statistics", rel: "low", dept: "DfE" },
            { n: 4, name: "General trade related aspects", rel: "low", dept: "DfE" },
            { n: 5, name: "Trade defence instruments", rel: "low", dept: "DfE" },
            { n: 6, name: "Regulations on bilateral safeguards", rel: "low", dept: "DfE" },
            { n: 7, name: "Others", rel: "medium", dept: "DoH" },
            { n: 8, name: "Goods - general provisions", rel: "high", dept: "DfE" },
            { n: 9, name: "Motor vehicles, including agricultural and forestry tractors", rel: "high", dept: "DfI" },
            { n: 10, name: "Lifting and mechanical handling appliances", rel: "medium", dept: "DfE" },
            { n: 11, name: "Gas appliances", rel: "high", dept: "DfE" },
            { n: 12, name: "Pressure vessels", rel: "medium", dept: "DfE" },
            { n: 13, name: "Measuring instruments", rel: "high", dept: "DfE" },
            { n: 14, name: "Construction products, machinery, cableways, PPE", rel: "high", dept: "DfE" },
            { n: 15, name: "Electrical and radio equipment", rel: "high", dept: "DfE" },
            { n: 16, name: "Textiles, footwear", rel: "high", dept: "DfE" },
            { n: 17, name: "Cosmetics, toys", rel: "high", dept: "DfE" },
            { n: 18, name: "Recreational craft", rel: "medium", dept: "DfI" },
            { n: 19, name: "Explosives and pyrotechnic articles", rel: "medium", dept: "DoJ" },
            { n: 20, name: "Medicinal products", rel: "high", dept: "DoH" },
            { n: 21, name: "Medical devices", rel: "high", dept: "DoH" },
            { n: 22, name: "Substances of human origin", rel: "high", dept: "DoH" },
            { n: 23, name: "Chemicals and related", rel: "high", dept: "DAERA" },
            { n: 24, name: "Pesticides, biocides", rel: "high", dept: "DAERA" },
            { n: 25, name: "Waste", rel: "medium", dept: "DAERA" },
            { n: 26, name: "Environment, energy efficiency", rel: "high", dept: "DAERA" },
            { n: 27, name: "Marine equipment", rel: "low", dept: "DfI" },
            { n: 28, name: "Rail transport", rel: "low", dept: "DfI" },
            { n: 29, name: "Food - general", rel: "high", dept: "DoH" },
            { n: 30, name: "Food - hygiene", rel: "high", dept: "DoH" },
            { n: 31, name: "Food - ingredients, traces, residues, marketing standards", rel: "high", dept: "DoH" },
            { n: 32, name: "Food contact material", rel: "high", dept: "DoH" },
            { n: 33, name: "Food - other", rel: "high", dept: "DoH" },
            { n: 34, name: "Feed - products and hygiene", rel: "medium", dept: "DAERA" },
            { n: 35, name: "GMOs", rel: "high", dept: "DAERA" },
            { n: 36, name: "Live animals, germinal products and products of animal origin", rel: "medium", dept: "DAERA" },
            { n: 37, name: "Animal disease control, zoonosis control", rel: "medium", dept: "DAERA" },
            { n: 38, name: "Animal identification", rel: "medium", dept: "DAERA" },
            { n: 39, name: "Animal breeding", rel: "low", dept: "DAERA" },
            { n: 40, name: "Animal welfare", rel: "high", dept: "DAERA" },
            { n: 41, name: "Plant health", rel: "medium", dept: "DAERA" },
            { n: 42, name: "Plant reproductive material", rel: "low", dept: "DAERA" },
            { n: 43, name: "Official controls, veterinary checks", rel: "medium", dept: "DAERA" },
            { n: 44, name: "Sanitary and phytosanitary - Other", rel: "high", dept: "DAERA" },
            { n: 45, name: "Intellectual property", rel: "high", dept: "DfE" },
            { n: 46, name: "Fisheries and aquaculture", rel: "medium", dept: "DAERA" },
            { n: 47, name: "Other", rel: "medium", dept: "DfE" }
        ];

        var LEGISLATION = [
            { id: 1, title: "Regulation (EU) 2025/XXX on general product safety (revision)", type: "Regulation", cat: 8, score: 24, priority: "critical", consultation: 12, dsc: "proposed_replacement" },
            { id: 2, title: "Directive (EU) 2025/XXX on toy safety (revision of 2009/48/EC)", type: "Directive", cat: 17, score: 23, priority: "critical", consultation: 8, dsc: "proposed_replacement" },
            { id: 3, title: "Regulation (EU) 2025/XXX amending cosmetic products Regulation", type: "Regulation", cat: 17, score: 17, priority: "high", consultation: 25, dsc: "proposed_new" }
        ];

        function renderLegislation(data) {
            var container = document.getElementById('legislation-list');
            var html = '';
            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                var cat = null;
                for (var j = 0; j < CATEGORIES.length; j++) {
                    if (CATEGORIES[j].n === item.cat) { cat = CATEGORIES[j]; break; }
                }
                var cardClass = item.isBaseline ? 'legislation-card baseline' : 'legislation-card ' + item.priority;
                var baselineBadge = item.isBaseline ? '<span class="baseline-badge">‚òÖ BASELINE</span>' : '';
                var amendsInfo = item.amendsTitle ? '<span class="meta-item"><strong>Amends:</strong> ' + item.amendsTitle.substring(0, 50) + '...</span>' : '';
                
                // Consultation countdown badge
                var consultationBadge = '';
                if (item.consultation && item.consultation > 0) {
                    var urgencyClass = item.consultation <= 7 ? 'urgent' : (item.consultation <= 14 ? 'soon' : 'normal');
                    var urgencyIcon = item.consultation <= 7 ? 'üö®' : (item.consultation <= 14 ? '‚è∞' : 'üìÖ');
                    consultationBadge = '<span class="consultation-countdown ' + urgencyClass + '">' + urgencyIcon + ' Closes in ' + item.consultation + ' days</span>';
                }
                
                html += '<div class="' + cardClass + '">' +
                    '<div class="legislation-header">' +
                    '<h3 class="legislation-title">' + baselineBadge + item.title + '</h3>' +
                    '<span class="priority-badge ' + item.priority + '">' + item.priority + '</span>' +
                    '</div>' +
                    '<div class="legislation-meta">' +
                    '<span class="meta-item"><strong>Type:</strong> ' + (item.type || 'Unknown') + '</span>' +
                    (item.isBaseline ? '' : '<span class="meta-item"><strong>Score:</strong> ' + item.score + '</span>') +
                    amendsInfo +
                    '</div>' +
                    '<div class="legislation-tags">' +
                    '<span class="tag category">' + (cat ? cat.n + '. ' + cat.name : 'Uncategorised') + '</span>' +
                    '<span class="tag department">' + (cat ? cat.dept : '') + '</span>' +
                    consultationBadge +
                    (item.dsc ? '<span class="tag dsc">DSC monitoring</span>' : '') +
                    '</div>' +
                    '<div class="legislation-actions">' +
                    '<a href="' + (item.eurlex || '#') + '" target="_blank" class="action-link primary">View on EUR-Lex</a>' +
                    (item.consultationUrl ? '<a href="' + item.consultationUrl + '" target="_blank" class="action-link consultation">Respond to Consultation</a>' : '') +
                    (item.dsc ? '<a href="#" class="action-link dsc">DSC Monitoring</a>' : '') +
                    '</div>' +
                    '</div>';
            }
            container.innerHTML = html;
        }

        function renderCategories() {
            var container = document.getElementById('categories-grid');
            var html = '';
            for (var i = 0; i < CATEGORIES.length; i++) {
                var cat = CATEGORIES[i];
                html += '<div class="category-card">' +
                    '<div class="category-number">Category ' + cat.n + '</div>' +
                    '<div class="category-name">' + cat.name + '</div>' +
                    '<div class="category-relevance ' + cat.rel + '">Consumer relevance: ' + cat.rel + '</div>' +
                    '<div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);"><strong>Dept:</strong> ' + cat.dept + '</div>' +
                    '</div>';
            }
            container.innerHTML = html;
        }

        function populateCategoryFilter() {
            var select = document.getElementById('filter-category');
            for (var i = 0; i < CATEGORIES.length; i++) {
                var cat = CATEGORIES[i];
                var option = document.createElement('option');
                option.value = cat.n;
                option.textContent = cat.n + '. ' + cat.name;
                select.appendChild(option);
            }
        }

        function applyFilters() {
            var priority = document.getElementById('filter-priority').value;
            var category = document.getElementById('filter-category').value;
            var search = document.getElementById('filter-search').value.toLowerCase();
            var typeFilter = document.getElementById('filter-type').value;

            var filtered = [];
            for (var i = 0; i < LEGISLATION.length; i++) {
                var item = LEGISLATION[i];
                if (priority && item.priority !== priority) continue;
                if (category && item.cat !== parseInt(category)) continue;
                if (search && item.title.toLowerCase().indexOf(search) === -1) continue;
                if (typeFilter === 'baseline' && !item.isBaseline) continue;
                if (typeFilter === 'recent' && item.isBaseline) continue;
                if (typeFilter === 'consultation' && !item.consultation) continue;
                filtered.push(item);
            }
            renderLegislation(filtered);
        }

        renderLegislation(LEGISLATION);
        renderCategories();
        populateCategoryFilter();

        // ============================================
        // SUPABASE CONNECTION (loads in background)
        // ============================================
        var SUPABASE_URL = 'https://emvqzjeohuslrplmzddq.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtdnF6amVvaHVzbHJwbG16ZGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNjM1MzcsImV4cCI6MjA4NTgzOTUzN30.2v6kmv-C9-zRMvS8-BGPdBTchfIzBKj8Vv1HoVR79Bs';

        function loadFromDatabase() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', SUPABASE_URL + '/rest/v1/legislation_dashboard?select=*', true);
            xhr.setRequestHeader('apikey', SUPABASE_KEY);
            xhr.setRequestHeader('Authorization', 'Bearer ' + SUPABASE_KEY);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            if (data && data.length > 0) {
                                // Transform database format to frontend format
                                var dbLegislation = [];
                                for (var i = 0; i < data.length; i++) {
                                    var row = data[i];
                                    dbLegislation.push({
                                        id: row.id,
                                        title: row.title,
                                        type: row.legislation_type,
                                        cat: row.category_number,
                                        score: row.total_score || 0,
                                        priority: row.priority_level || 'low',
                                        consultation: row.consultation_days_remaining,
                                        consultationUrl: row.consultation_url,
                                        dsc: row.dsc_status,
                                        eurlex: row.eurlex_url,
                                        isBaseline: row.is_baseline || false,
                                        amendsCelex: row.amends_celex,
                                        amendsTitle: row.amends_title
                                    });
                                }
                                // Replace sample data with real data
                                LEGISLATION = dbLegislation;
                                renderLegislation(LEGISLATION);
                                updateStats();
                                console.log('Loaded ' + data.length + ' items from database');
                            }
                        } catch (e) {
                            console.log('Database parse error, using sample data');
                        }
                    } else {
                        console.log('Database unavailable, using sample data');
                    }
                }
            };
            
            xhr.onerror = function() {
                console.log('Network error, using sample data');
            };
            
            xhr.send();
        }

        function updateStats() {
            var critical = 0, high = 0, medium = 0, consultations = 0;
            for (var i = 0; i < LEGISLATION.length; i++) {
                var item = LEGISLATION[i];
                if (item.priority === 'critical') critical++;
                if (item.priority === 'high') high++;
                if (item.priority === 'medium') medium++;
                if (item.consultation) consultations++;
            }
            document.getElementById('stat-critical').textContent = critical;
            document.getElementById('stat-high').textContent = high;
            document.getElementById('stat-medium').textContent = medium;
            document.getElementById('stat-consultations').textContent = consultations;
        }

        // Try to load from database (won't break page if it fails)
        loadFromDatabase();
    </script>
</body>
</html>
